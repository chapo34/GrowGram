rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    function isSignedIn() { return request.auth != null; }

    // Medien der Posts: uploads/{uid}/...
    match /uploads/{userId}/{allPaths=**} {
      // Lesen nur bei public-Metadatum oder Owner
      allow read: if resource != null &&
                  (resource.metadata.visibility == 'public' ||
                   (isSignedIn() && request.auth.uid == userId));
      allow write: if false; // Upload/Löschen nur via Cloud Functions
    }

    // Avatare: avatars/{uid}/...
    match /avatars/{userId}/{allPaths=**} {
      allow read: if true;   // Avatare dürfen öffentlich sein
      allow write: if false;
    }

    match /{path=**} {
      allow read, write: if false;
    }
  }
}