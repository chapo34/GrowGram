rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    /** Utils */
    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }

    /** DEFAULT: alles dicht */
    match /{document=**} {
      allow read, write: if false;
    }

    /** USERS
     *  - Lesen: nur eigenes Dokument
     *  - Anlegen/Updaten: nur Owner und nur erlaubte Felder
     *  - Server-only Felder dürfen NICHT per Client mutiert werden
     */
    match /users/{userId} {
      allow read: if isOwner(userId);

      // create: nur für sich selbst und nur whitelisted Felder
      allow create: if isOwner(userId)
                    && request.resource.data.keys().hasOnly([
                      'firstName','lastName','displayName','bio','city','avatarUrl','website',
                      'createdAt','updatedAt'
                    ]);

      // update: nur Owner + nur Whitelist; „server-only“ Keys strikt gesperrt
      allow update: if isOwner(userId)
                    && request.resource.data.diff(resource.data).changedKeys()
                       .hasOnly(['firstName','lastName','displayName','bio','city','avatarUrl','website','updatedAt'])
                    && !request.resource.data.diff(resource.data).changedKeys()
                       .hasAny(['email','isVerified','hideSensitive','over18Ack','complianceAt','lastComplianceDevice','createdAt']);

      allow delete: if false;
    }

    /** POSTS
     *  - Lesen: öffentlich (Feed)
     *  - Schreiben: nur über Admin-SDK (Backend) ⇒ Client: deny
     */
    match /posts/{postId} {
      allow read: if true;
      allow write: if false;
    }

    /** COMMENTS (öffentlich lesen; schreiben via Backend) */
    match /comments/{commentId} {
      allow read: if true;
      allow write: if false;
    }

    /** CHATS
     *  - Threads lesen: nur Members
     *  - Erstellen: nur DMs (2 Members) und nur wenn der Anfragende Mitglied ist
     *  - Messages: lesen/schreiben nur für Members; kein Update/Delete
     */
    match /chats/{threadId} {
      allow read: if isSignedIn()
                  && resource.data.members is list
                  && request.auth.uid in resource.data.members;

      allow create: if isSignedIn()
                    && request.resource.data.members is list
                    && request.resource.data.members.size() == 2
                    && request.auth.uid in request.resource.data.members;

      allow update, delete: if false;

      match /messages/{msgId} {
        // defensiv: vor get() prüfen, dass Chat existiert
        function chatExists() {
          return exists(/databases/$(db)/documents/chats/$(threadId));
        }
        function isMember() {
          return chatExists() &&
            request.auth.uid in get(/databases/$(db)/documents/chats/$(threadId)).data.members;
        }

        allow read: if isSignedIn() && isMember();
        allow create: if isSignedIn()
                      && request.resource.data.senderId == request.auth.uid
                      && isMember();

        allow update, delete: if false;
      }
    }

    /** (Optional) Warte-Liste – wenn dein Frontend hier direkt schreiben soll.
     *  Falls nur Backend schreibt: diesen Block entfernen/auf write:false setzen.
     */
    match /waitlist/{emailId} {
      allow read: if false;
      allow create: if true; // oder stricter: isSignedIn()
      allow update, delete: if false;
    }
  }
}