<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GrowGram â€“ Teilen empfangen</title>
  <style>
    :root{--brand:#4CAF50;--text:#E6EAEF;--muted:#9AA6B2;--bg:#111316;--card:#1A1F24;--ring:#26313A;--radius:16px}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;min-height:100svh;display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{width:100%;max-width:760px}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);padding:22px}
    h1{margin:0 0 10px;font-size:clamp(22px,3.5vw,28px)}
    p{margin:0 0 12px;color:var(--muted)}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));margin-top:12px}
    .file{border:1px solid var(--ring);border-radius:12px;padding:10px}
    .file small{color:#8ea0ad}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;text-decoration:none;display:inline-block}
    .btn.primary{background:var(--brand);color:#08150d}
    .btn.ghost{background:transparent;border:1px solid var(--ring);color:var(--muted)}
    .hint{margin-top:10px;color:#8ea0ad;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Geteilte Inhalte</h1>
      <p id="meta"></p>
      <div id="files" class="grid"></div>
      <div class="actions">
        <a class="btn primary" id="openApp" href="growgram://share">In der App Ã¶ffnen</a>
        <a class="btn ghost" href="/">Zur Startseite</a>
      </div>
      <div class="hint">Hinweis: In der PWA werden Dateien lokal gehalten (IndexedDB). Beim Ã–ffnen in der nativen App bitte erneut auswÃ¤hlen/uploaden.</div>
    </div>
  </div>

  <script>
    // SW registrieren (falls nicht schon global)
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/sw.js'); }

    function fmtBytes(b){ if(!b && b!==0) return ''; const u=['B','KB','MB','GB']; let i=0; while(b>=1024 && i<u.length-1){b/=1024;i++;} return b.toFixed(1)+' '+u[i]; }

    async function idbOpen(name, ver) {
      return await new Promise((res, rej) => {
        const req = indexedDB.open(name, ver);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains('meta')) db.createObjectStore('meta');
          if (!db.objectStoreNames.contains('files')) db.createObjectStore('files');
        };
        req.onsuccess = () => res(req.result);
        req.onerror = () => rej(req.error);
      });
    }
    async function idbGet(db, store, key) {
      return await new Promise((res, rej) => {
        const tx = db.transaction(store, 'readonly');
        const req = tx.objectStore(store).get(key);
        req.onsuccess = () => res(req.result);
        req.onerror = () => rej(req.error);
      });
    }

    (async () => {
      const db = await idbOpen('gg-share', 1);
      const meta = await idbGet(db, 'meta', 'last');
      const $meta = document.getElementById('meta');
      const $files = document.getElementById('files');

      if (!meta) {
        $meta.textContent = 'Keine Daten gefunden. Bitte erneut teilen.';
        return;
      }
      const parts = [];
      if (meta.title) parts.push('Titel: ' + meta.title);
      if (meta.text) parts.push('Text: ' + meta.text);
      if (meta.url) parts.push('Link: ' + meta.url);
      $meta.textContent = parts.join(' Â· ') || 'Metadaten vorhanden.';

      if (meta.files && meta.files.length) {
        for (const f of meta.files) {
          const blob = await idbGet(db, 'files', f.key);
          const url = blob ? URL.createObjectURL(blob) : null;
          const card = document.createElement('div');
          card.className = 'file';
          card.innerHTML = `
            <div style="aspect-ratio:4/3;background:#0e1317;border-radius:8px;display:grid;place-items:center;overflow:hidden;margin-bottom:6px">
              ${url && blob.type.startsWith('image/') ? `<img src="${url}" alt="" style="max-width:100%;max-height:100%">` : 'ðŸ“„'}
            </div>
            <div><strong>${f.name || 'Datei'}</strong></div>
            <small>${f.type || ''} Â· ${fmtBytes(f.size)}</small>
          `;
          $files.appendChild(card);
        }
      }
    })();
  </script>
</body>
</html>